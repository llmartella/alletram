name: Create Monthly Task

on:
  schedule:
    - cron: '0 12 1-7 * 6' # First Saturday of every month at 12:00 PM UTC
  workflow_dispatch:

permissions:
  issues: write
  contents: read

jobs:
  create-task:
    runs-on: ubuntu-latest

    steps:
      - name: Create an issue and assign it to a project
        env:
          GITHUB_TOKEN: ${{ secrets.PROJECTS_TOKEN }} # Use the PAT stored as a secret
        run: |
          # Step 1: Create the issue
          ISSUE_RESPONSE=$(curl -X POST -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{
              "title": "Monthly Task for '"$(date +'%B')"'", 
              "body": "### Tasks for '"$(date +'%B')"'\n- [ ] Task 1\n- [ ] Task 2\n- [ ] Task 3", 
              "assignees": ["username"], 
              "labels": ["monthly-task"]
            }' \
            https://api.github.com/repos/llmartella/alletram/issues)

          # Extract the issue node_id
          ISSUE_NODE_ID=$(echo "$ISSUE_RESPONSE" | jq -r '.node_id')

          # Step 2: Add the issue to a project
          curl -X POST -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{
              "projectId": "PVT_kwHODDdG4s4A194P", 
              "contentId": "'"$ISSUE_NODE_ID"'"
            }' \
            https://api.github.com/graphql
